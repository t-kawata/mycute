#!/bin/bash

while getopts ":o:a:" opt; do
  case $opt in
    o) OS="$OPTARG"
    ;;
    a) ARCH="$OPTARG"
    ;;
    \?) echo "Invalid option -$OPTARG" >&2
    ;;
  esac
done

BINARY_NAME="mycute"

if [ "${OS}" = "" ]; then
  OS=$(uname -s | tr '[:upper:]' '[:lower:]')
else
  BINARY_NAME="${BINARY_NAME}-${OS}"
fi

if [ "${ARCH}" = "" ]; then
  ARCH=$(uname -m)
else
  BINARY_NAME="${BINARY_NAME}-${ARCH}"
fi

VERSION=$(cat config/settings.go | grep "const VERSION" | awk -F'"' '{print $2}')
echo "Current version is ${VERSION}."

# Compilation setup
export CGO_ENABLED=1

if [ "${OS}" = "linux" ]; then
  echo "Building for Linux with cross-compilation..."
  
  if ! command -v zig >/dev/null 2>&1; then
    echo "Error: Zig is not installed. Zig is required for safe Linux cross-compilation."
    echo "Please install it via: brew install zig"
    exit 1
  fi

  echo "Using Zig as the cross-compiler."
  export CC="zig cc -target x86_64-linux-gnu.2.38"
  export CXX="zig c++ -target x86_64-linux-gnu.2.38"
else
  # macOS or other platforms
  if [ "${OS}" = "darwin" ]; then
    export CGO_LDFLAGS="-framework Security"
  fi
fi

# Build command execution
CMD="GOOS=${OS} GOARCH=${ARCH} go build -o ../dist/${BINARY_NAME} main.go"
echo "$CMD"
eval "$CMD"

exit 0
